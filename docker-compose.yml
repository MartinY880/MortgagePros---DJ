version: '3.8'

services:
  spotify-jukebox:
    image: ghostreaper69/mtgprosdj:v0.2.5
    container_name: dj
    restart: unless-stopped
    
    # Note: If using Traefik, you can comment out the ports section
    # Traefik will handle the routing
    # ports:
    #   - "5000:5000"  # Backend API and WebSocket
    #   - "5173:5173"  # Frontend
    
    labels:
      # Enable Traefik
      - traefik.enable=true
      - traefik.docker.network=traefik
      
      # Backend router - API subdomain
      - traefik.http.routers.spotify-jukebox-backend.rule=Host(`api-dj.pros.mortgage`)
      - traefik.http.routers.spotify-jukebox-backend.entrypoints=websecure
      - traefik.http.routers.spotify-jukebox-backend.tls.certresolver=letsencrypt
      - traefik.http.routers.spotify-jukebox-backend.service=spotify-jukebox-backend
      - traefik.http.services.spotify-jukebox-backend.loadbalancer.server.port=5000
      
      # Frontend router - main domain
      - traefik.http.routers.spotify-jukebox-frontend.rule=Host(`dj.pros.mortgage`)
      - traefik.http.routers.spotify-jukebox-frontend.entrypoints=websecure
      - traefik.http.routers.spotify-jukebox-frontend.tls.certresolver=letsencrypt
      - traefik.http.routers.spotify-jukebox-frontend.service=spotify-jukebox-frontend
      - traefik.http.routers.spotify-jukebox-frontend.priority=1
      - traefik.http.services.spotify-jukebox-frontend.loadbalancer.server.port=5173
    
    environment:
      # Spotify API Credentials (REQUIRED)
      SPOTIFY_CLIENT_ID: "${SPOTIFY_CLIENT_ID}"
      SPOTIFY_CLIENT_SECRET: "${SPOTIFY_CLIENT_SECRET}"
      # Update this to your domain when using Traefik
      SPOTIFY_REDIRECT_URI: "${SPOTIFY_REDIRECT_URI:-https://api-dj.pros.mortgage/api/auth/callback}"

      # Server Configuration
      PORT: "5000"
      NODE_ENV: "${NODE_ENV:-production}"
      SESSION_SECRET: "${SESSION_SECRET}"
      CLERK_PUBLISHABLE_KEY: "${CLERK_PUBLISHABLE_KEY}"
      CLERK_SECRET_KEY: "${CLERK_SECRET_KEY}"

      # Frontend URL - Update this to your domain when using Traefik
      FRONTEND_URL: "${FRONTEND_URL:-https://dj.pros.mortgage}"
      # Comma-separated list of allowed frontend origins (include every domain hitting the API)
      FRONTEND_ORIGINS: "${FRONTEND_ORIGINS:-https://dj.pros.mortgage,https://dj-dev.pros.mortgage}"
      # Frontend runtime configuration exposed through /api/config
      FRONTEND_API_BASE_URL: "${FRONTEND_API_BASE_URL:-https://api-dj.pros.mortgage/api}"
      FRONTEND_SOCKET_URL: "${FRONTEND_SOCKET_URL:-https://api-dj.pros.mortgage}"

      # Database (override via .env if needed)
    DATABASE_URL: "${DATABASE_URL:-file:/app/backend/data/prod.db}"

    # Librespot managed Spotify Connect receiver
    LIBRESPOT_ENABLED: "${LIBRESPOT_ENABLED:-false}"
    LIBRESPOT_DEVICE_NAME: "${LIBRESPOT_DEVICE_NAME:-MortgagePros DJ}"
    LIBRESPOT_TRANSFER_ON_QUEUE: "${LIBRESPOT_TRANSFER_ON_QUEUE:-true}"
    LIBRESPOT_DISCOVERY_TIMEOUT_MS: "${LIBRESPOT_DISCOVERY_TIMEOUT_MS:-15000}"
    LIBRESPOT_BACKEND: "${LIBRESPOT_BACKEND:-rodio}"
    LIBRESPOT_BITRATE: "${LIBRESPOT_BITRATE:-160}"
    LIBRESPOT_USERNAME: "${LIBRESPOT_USERNAME:-}"
    LIBRESPOT_PASSWORD: "${LIBRESPOT_PASSWORD:-}"
    LIBRESPOT_DISABLE_DISCOVERY: "${LIBRESPOT_DISABLE_DISCOVERY:-}"
    LIBRESPOT_EXTRA_ARGS: "${LIBRESPOT_EXTRA_ARGS:-}"
    
    volumes:
      # Persist database to local directory
      - ./data:/app/backend/data
      # Persist librespot cache (stores auth blob when discovery pairing is used)
      - ./librespot-cache:/app/librespot-cache
      # Optional: Mount custom .env file
      # - ./.env:/app/.env:ro
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    networks:
      - spotify-jukebox-network
      - traefik
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  spotify-jukebox-data:
    driver: local

networks:
  spotify-jukebox-network:
    driver: bridge
  traefik:
    external: true
