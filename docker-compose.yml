version: '3.8'

services:
  spotify-jukebox:
    build:
      context: .
      dockerfile: Dockerfile
    image: spotify-jukebox:latest
    container_name: spotify-jukebox
    restart: unless-stopped
    
    # Note: If using Traefik, you can comment out the ports section
    # Traefik will handle the routing
    ports:
      - "5000:5000"  # Backend API and WebSocket
      - "5173:5173"  # Frontend
    
    labels:
      # Enable Traefik
      - traefik.enable=true
      - traefik.docker.network=traefik
      
      # Frontend router (main domain)
      - traefik.http.routers.spotify-jukebox-frontend.rule=Host(`your-domain-here`)
      - traefik.http.routers.spotify-jukebox-frontend.entrypoints=websecure
      - traefik.http.routers.spotify-jukebox-frontend.tls.certresolver=letsencrypt
      - traefik.http.routers.spotify-jukebox-frontend.service=spotify-jukebox-frontend
      - traefik.http.services.spotify-jukebox-frontend.loadbalancer.server.port=5173
      
      # Backend router (API subdomain or path)
      # Option 1: Using subdomain (api.your-domain-here)
      - traefik.http.routers.spotify-jukebox-backend.rule=Host(`api.your-domain-here`)
      # Option 2: Using path prefix (uncomment and comment above if preferred)
      # - traefik.http.routers.spotify-jukebox-backend.rule=Host(`your-domain-here`) && PathPrefix(`/api`, `/socket.io`)
      - traefik.http.routers.spotify-jukebox-backend.entrypoints=websecure
      - traefik.http.routers.spotify-jukebox-backend.tls.certresolver=letsencrypt
      - traefik.http.routers.spotify-jukebox-backend.service=spotify-jukebox-backend
      - traefik.http.services.spotify-jukebox-backend.loadbalancer.server.port=5000
    
    environment:
      # Spotify API Credentials (REQUIRED)
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      # Update this to your domain when using Traefik
      - SPOTIFY_REDIRECT_URI=${SPOTIFY_REDIRECT_URI:-https://api.your-domain-here/api/auth/callback}
      
      # Server Configuration
      - PORT=5000
      - NODE_ENV=${NODE_ENV:-production}
      
      # Session Secret (REQUIRED - generate a random string)
      - SESSION_SECRET=${SESSION_SECRET}
      
      # Frontend URL - Update this to your domain when using Traefik
      - FRONTEND_URL=${FRONTEND_URL:-https://your-domain-here}
      
      # Database
      - DATABASE_URL=file:/app/backend/data/prod.db
    
    volumes:
      # Persist database to local directory
      - ./data:/app/backend/data
      # Optional: Mount custom .env file
      # - ./.env:/app/.env:ro
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    networks:
      - spotify-jukebox-network
      - traefik
    
    # Security settings
    security_opt:
      - no-new-privileges:true
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  spotify-jukebox-data:
    driver: local

networks:
  spotify-jukebox-network:
    driver: bridge
  traefik:
    external: true
