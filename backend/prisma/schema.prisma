// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  spotifyId     String    @unique
  displayName   String
  email         String?
  accessToken   String
  refreshToken  String
  tokenExpiry   DateTime
  playbackDeviceId      String?
  playbackDeviceName    String?
  playbackDeviceType    String?
  playbackDeviceLastSeen DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveSessionId String?
  
  hostedSessions Session[] @relation("HostedSessions")
  lastActiveSession Session? @relation("LastActiveSession", fields: [lastActiveSessionId], references: [id])
  scheduledPlaybacks ScheduledPlayback[] @relation("ScheduledPlaybackCreator")
  queueItems     QueueItem[]
  votes          Vote[]
}

model Session {
  id          String    @id @default(uuid())
  code        String    @unique
  name        String
  hostId      String
  isActive    Boolean   @default(true)
  allowExplicit Boolean @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  host        User      @relation("HostedSessions", fields: [hostId], references: [id], onDelete: Cascade)
  queueItems  QueueItem[]
  guests      Guest[]
  lastActiveUsers User[] @relation("LastActiveSession")
  scheduledPlaybacks ScheduledPlayback[]
  
  @@index([code])
  @@index([hostId])
}

model QueueItem {
  id              String    @id @default(uuid())
  sessionId       String
  spotifyTrackId  String
  trackName       String
  trackArtist     String
  trackAlbum      String?
  trackImage      String?
  trackDuration   Int
  addedById       String?
  addedByGuestId  String?
  voteScore       Int       @default(0)
  isNextUp        Boolean   @default(false)
  played          Boolean   @default(false)
  playedAt        DateTime?
  createdAt       DateTime  @default(now())
  
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  addedBy         User?     @relation(fields: [addedById], references: [id], onDelete: Cascade)
  addedByGuest    Guest?    @relation(fields: [addedByGuestId], references: [id], onDelete: Cascade)
  votes           Vote[]
  
  @@index([sessionId, played, voteScore])
  @@index([spotifyTrackId])
}

model Vote {
  id            String    @id @default(uuid())
  queueItemId   String
  userId        String?
  guestId       String?
  voteType      Int       // 1 for upvote, -1 for downvote
  createdAt     DateTime  @default(now())
  
  queueItem     QueueItem @relation(fields: [queueItemId], references: [id], onDelete: Cascade)
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  guest         Guest?    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  
  @@unique([queueItemId, userId])
  @@unique([queueItemId, guestId])
  @@index([queueItemId])
  @@index([userId])
  @@index([guestId])
}

model Guest {
  id         String     @id @default(uuid())
  sessionId  String
  name       String
  clerkUserId String?
  createdAt  DateTime   @default(now())

  session    Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  queueItems QueueItem[]
  votes      Vote[]

  @@index([sessionId])
  @@index([clerkUserId])
}

enum ScheduledPlaybackStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model ScheduledPlayback {
  id             String                  @id @default(uuid())
  sessionId      String
  createdById    String
  scheduledFor   DateTime
  isRecurringDaily Boolean              @default(false)
  timeOfDayMinutes Int?
  timezoneOffsetMinutes Int?
  status         ScheduledPlaybackStatus @default(PENDING)
  completedAt    DateTime?
  failureReason  String?
  lastRunAt      DateTime?
  lastRunStatus  ScheduledPlaybackStatus?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  session        Session                 @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdBy      User                    @relation("ScheduledPlaybackCreator", fields: [createdById], references: [id], onDelete: Cascade)
  tracks         ScheduledPlaybackTrack[]

  @@index([sessionId])
  @@index([scheduledFor])
  @@index([status])
}

model ScheduledPlaybackTrack {
  id                  String             @id @default(uuid())
  scheduledPlaybackId String
  order               Int
  spotifyTrackId      String
  spotifyUri          String
  trackName           String
  trackArtist         String
  trackAlbum          String?
  trackImage          String?
  trackDuration       Int
  createdAt           DateTime           @default(now())

  scheduledPlayback   ScheduledPlayback  @relation(fields: [scheduledPlaybackId], references: [id], onDelete: Cascade)

  @@index([scheduledPlaybackId, order])
}
